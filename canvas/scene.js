let sceneWidth=400,sceneHeight=800;const canvas=new fabric.Canvas("canvasBox",{stopContextMenu:!0,controlsAboveOverlay:!0,preserveObjectStacking:!0,altSelectionKey:"altKey",width:400,height:800});canvas.setBackgroundColor("blue",canvas.renderAll.bind(canvas));const stack=[],save=()=>{const e=canvas.toJSON(["id","selectable","hasControls"]);console.log("saved data",e),stack.push(e)};canvas.on({"object:modified":save,"selection:updated":save});const zoomOutBtn=getById("zoomOut"),zoomInBtn=getById("zoomIn"),undoBtn=getById("undo"),exportBtn=getById("export"),resetBtn=getById("reset");zoomOutBtn.addEventListener("click",(()=>{setZoom(.5)})),zoomInBtn.addEventListener("click",(()=>{setZoom(2)})),resetBtn.addEventListener("click",(()=>{canvas.setWidth(sceneWidth),canvas.setHeight(sceneHeight),setZoom(1)})),undoBtn.addEventListener("click",(()=>{if(canvas.getActiveObjects().length>0)return void canvas.discardActiveObject();const e=stack.pop();console.log("上一次的数据",e),e&&(canvas.clear(),canvas.loadFromJSON(e,canvas.renderAll.bind(canvas)),canvas.requestRenderAll())})),exportBtn.addEventListener("click",(()=>{console.log(canvas.toJSON())}));const initWorkshop=()=>{const e=document.querySelector("#workshop");canvas.setWidth(e.offsetWidth),canvas.setHeight(e.offsetHeight);const t=canvas.getCenter(),n=new fabric.Rect({fill:"blue",width:400,height:800,id:"workspace",left:t.left,top:t.top,originX:"center",originY:"center",selectable:!1,hasControls:!1});n.hoverCursor="default",canvas.add(n),canvas.renderAll(),n.clone((e=>{canvas.clipPath=e,canvas.requestRenderAll()}))},center=canvas.getCenter(),circle=new fabric.Circle({name:"circle",left:center.left,top:center.top,radius:60,fill:"pink",originX:"center",originY:"center"}),rect=new fabric.Rect({name:"rect",left:center.left,top:center.top,width:200,height:100,fill:"#fff",originX:"center",originY:"center"}),iText=new fabric.IText("hello world",{left:center.left,top:center.top,originX:"center",originY:"center",fill:"#fff"}),textbox=new fabric.Textbox("hello world",{left:center.left,top:center.top,originX:"center",originY:"center",fill:"#fff",width:200});function setZoom(e){let t=canvas.width,n=canvas.height;if(canvas.setWidth(t*e),canvas.setHeight(n*e),canvas.backgroundImage){const t=canvas.backgroundImage;t.width=t.width*e,t.height=t.height*e}const c=canvas.getObjects();for(let t in c){let n=c[t].scaleX*e,a=c[t].scaleY*e,o=c[t].left*e,s=c[t].top*e;c[t].scaleX=n,c[t].scaleY=a,c[t].left=o,c[t].top=s,c[t].setCoords()}canvas.renderAll(),canvas.calcOffset()}canvas.add(textbox),save(),canvas.on("mouse:wheel",(e=>{const t=e.e.deltaY;let n=canvas.getZoom();n*=.999**t,n>20&&(n=20),n<.01&&(n=.01),console.log(n),setZoom(n),e.e.preventDefault(),e.e.stopPropagation()}));