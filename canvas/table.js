fabric.TableCell=fabric.util.createClass(fabric.Group,{type:"tableCell",text:null,rect:null,initialize:function(t,e,i){this.rect=new fabric.Rect(t),this.text=new fabric.Textbox(i,{...e,selectable:!1,evented:!1}),this.on("mousedblclick",(()=>{this.text.selectable=!0,this.text.evented=!0,this.canvas.setActiveObject(this.text),this.text.set({editingBorderColor:"rgba(0,0,0,0)",borderColor:"rgba(0,0,0,0)",cursorDelay:100,cursorDuration:300}),this.canvas.renderAll(),this.text.enterEditing(),this.text.hiddenTextarea.focus();for(let t=this.text.text.length;t>0;)this.text.moveCursorRight((function(t){})),t--})),this.on("mousedown",(()=>{console.log("red"),this.rect.set("fill","green"),this.canvas.requestRenderAll()})),this.text.on("editing:exited",(()=>{this.text.selectable=!1,this.text.evented=!1,this.selectable=!0})),this.callSuper("initialize",[this.rect,this.text],{subTargetCheck:!0,objectCaching:!1})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"),{text:this.text.get("text")})},fromObject:function(t){console.log("o",t)}}),fabric.Table=fabric.util.createClass(fabric.Group,{type:"table",rowHeights:[],columnWidths:[],initialize:function(t){const{borderWidth:e,rowHeights:i,columnWidths:o,cells:n}=t,l=t.cellHeight||40,a=t.cellWidth||160,c={left:10,top:10,width:a,height:l,rx:0,stroke:"#000",fill:"transparent",shadow:0,strokeWidth:+e,strokeUniform:!0},r={left:35,top:30,width:a,height:l,lineHeight:l,fontSize:20,stroke:"#fff",fill:"#fff",selectable:!1,textAlign:"center"},s=[],h=[];let f=0;for(let t=0;t<i.length;t++){let e=0;for(let l=0;l<o.length;l++){let{rowSpan:a=0,colSpan:d=0,content:u}=n.find((e=>e.row==t&&e.col==l))||{};const p=+i[t],g=+o[l];a=parseInt(a),d=parseInt(d),a=Math.min(i.length-1,a),d=Math.min(o.length-1,d);let b=g,w=p,m=0,S=0;for(let e=1;e<=a;e++)m+=i[t+e],s.push(`${t+e}:${l}`);for(let e=1;e<=d;e++)S+=o[l+e],s.push(`${t}:${l+e}`);if(a>0&&d>0)for(let e=1;e<=a;e++)for(let i=1;i<=d;i++)s.push(`${t+e}:${l+i}`);if(w+=m,b+=S,s.includes(`${t}:${l}`)){e+=g;continue}const v=new fabric.TableCell({...c,left:e+1,top:f,width:b,height:w},{...r,left:e+1+c.strokeWidth,top:f+c.strokeWidth,width:b,height:w},u||`${t}-${l}`);h.push(v),e+=g}f+=i[t]}this.rowHeights=i,this.columnWidths=o,this.callSuper("initialize",h,{subTargetCheck:!0,objectCaching:!1})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"),{rowHeights:this.get("rowHeights"),columnWidths:this.get("columnWidths")})}}),fabric.Table.fromObject=function(t,e){const i=new fabric.Table({x:"4.188",lockLocation:"true",y:"9.594",width:"32.848",rotationAngle:"0",rowHeights:[80,120,160],columnWidths:[160,100,100],controlType:"2",elementType:10,borderWidth:20,height:"11.500",cells:[{colSpan:3,hAlignment:"2",italic:"false",bold:"false",automaticHeightCalculation:"true",linesSpace:"0.0",blackWhiteReflection:"false",textSize:"5.981000",strikethrough:"false",fontType:"1",lineWrap:"true",horizontalAlignment:"true",underline:"false",wordSpace:"0.100",row:"0",rowSpan:1,content:"中国",col:"0"},{colSpan:0,hAlignment:"2",italic:"false",bold:"false",automaticHeightCalculation:"true",linesSpace:"0.0",blackWhiteReflection:"false",textSize:"5.981000",strikethrough:"false",fontType:"1",lineWrap:"true",horizontalAlignment:"true",underline:"false",wordSpace:"0.100",row:"0",rowSpan:0,content:"头疼疼",col:"1"},{colSpan:"0",hAlignment:"2",italic:"false",bold:"false",automaticHeightCalculation:"true",linesSpace:"0.0",blackWhiteReflection:"false",textSize:"5.981000",strikethrough:"false",fontType:"1",lineWrap:"true",horizontalAlignment:"true",underline:"false",wordSpace:"0.100",row:"0",rowSpan:"0",content:"",col:"2"},{colSpan:"0",hAlignment:"2",italic:"false",bold:"false",automaticHeightCalculation:"true",linesSpace:"0.0",blackWhiteReflection:"false",textSize:"5.981000",strikethrough:"false",fontType:"1",lineWrap:"true",horizontalAlignment:"true",underline:"false",wordSpace:"0.100",row:"1",rowSpan:"0",content:"",col:"0"},{colSpan:"0",hAlignment:"2",italic:"false",bold:"false",automaticHeightCalculation:"true",linesSpace:"0.0",blackWhiteReflection:"false",textSize:"5.981000",strikethrough:"false",fontType:"1",lineWrap:"true",horizontalAlignment:"true",underline:"false",wordSpace:"0.100",row:"1",rowSpan:"0",content:"",col:"1"},{colSpan:"0",hAlignment:"2",italic:"false",bold:"false",automaticHeightCalculation:"true",linesSpace:"0.0",blackWhiteReflection:"false",textSize:"5.981000",strikethrough:"false",fontType:"1",lineWrap:"true",horizontalAlignment:"true",underline:"false",wordSpace:"0.100",row:"1",rowSpan:"0",content:"",col:"2"},{colSpan:"0",hAlignment:"2",italic:"false",bold:"false",automaticHeightCalculation:"true",linesSpace:"0.0",blackWhiteReflection:"false",textSize:"5.981000",strikethrough:"false",fontType:"1",lineWrap:"true",horizontalAlignment:"true",underline:"false",wordSpace:"0.100",row:"2",rowSpan:"0",content:"54545",col:"0"},{colSpan:"0",hAlignment:"2",italic:"false",bold:"false",automaticHeightCalculation:"true",linesSpace:"0.0",blackWhiteReflection:"false",textSize:"5.981000",strikethrough:"false",fontType:"1",lineWrap:"true",horizontalAlignment:"true",underline:"false",wordSpace:"0.100",row:"2",rowSpan:"0",content:"fff",col:"1"},{colSpan:"0",hAlignment:"2",italic:"false",bold:"false",automaticHeightCalculation:"true",linesSpace:"0.0",blackWhiteReflection:"false",textSize:"5.981000",strikethrough:"false",fontType:"1",lineWrap:"true",horizontalAlignment:"true",underline:"false",wordSpace:"0.100",row:"2",rowSpan:"0",content:"ff",col:"2"}],takePrint:"true"});return i.left=t.left,i.top=t.top,e(i),i};class LabelEditor{canvas;history=[];constructor(t){this.init(t)}init(t){const e=new fabric.Canvas(t,{stopContextMenu:!0,controlsAboveOverlay:!0,preserveObjectStacking:!0,altSelectionKey:"altKey"});this.canvas=e,window.innerWidth,window.innerHeight,this.initWorkshop(),this.initZoom(),this.initHistory(),this.initExport(),this.initEvents(),this.addTable(),this.save()}initWorkshop({width:t,height:e}={width:800,height:800}){const i=this.canvas,o=document.querySelector("#workshop");i.setWidth(o.offsetWidth),i.setHeight(o.offsetHeight);const n=i.getCenter(),l=new fabric.Rect({fill:"blue",width:t,height:e,id:"workspace",left:n.left,top:n.top,originX:"center",originY:"center",selectable:!1,hasControls:!1});l.hoverCursor="default",i.add(l),l.clone((t=>{i.clipPath=t,i.requestRenderAll()}))}initEvents(){const t=document.getElementById("add"),e=document.getElementById("remove");t.addEventListener("click",(()=>{const t=this.getRandomShape(),e=this.canvas.getCenter();t.set("left",e.left-t.width/2),t.set("top",e.top-t.height/2),this.canvas.add(t),this.save()})),e.addEventListener("click",(()=>{const t=this.canvas.getActiveObjects();t.length>0&&(this.canvas.discardActiveObject(),t.forEach((t=>this.canvas.remove(t))),this.save())})),["centerH","centerV","center"].forEach((t=>{this.elById(t).addEventListener("click",(()=>{const e=this.canvas.getActiveObject();e&&e[t]()}))}))}initHistory(){const t=this.canvas;t.on({"object:modified":this.save.bind(this)}),document.getElementById("undo").addEventListener("click",(()=>{const e=this.history;t.getActiveObjects().length>0&&t.discardActiveObject();const i=e[e.length-2];console.log("undo ",e,i),i&&(t.clear(),t.loadFromJSON(i,(()=>{t.renderAll(),e.pop(),console.log("undo after",e)})))}))}save(t){console.log("save evt: ",t);const e=this.canvas,i=this.history,o=e.toJSON(["id","selectable","hasControls","compType"]);console.log("saved data",o),i.push(o)}initExport(){const t=this.canvas;document.getElementById("export").addEventListener("click",(()=>{console.log(t.toJSON(["compType"]))}))}initZoom(){const t=this.canvas;t.on("mouse:wheel",(e=>{const i=e.e.deltaY;let o=t.getZoom();o*=.999**i,o>20&&(o=20),o<.01&&(o=.01);const n=t.getCenter();t.zoomToPoint({x:n.left,y:n.top},o),e.e.preventDefault(),e.e.stopPropagation()}))}addTable(){const t=this.canvas,e=t.getCenter(),i=new fabric.Table({x:"4.188",lockLocation:"true",y:"9.594",width:"32.848",rotationAngle:"0",rowHeights:[80,120],columnWidths:[160,100,100],controlType:"2",elementType:10,borderWidth:4,height:"11.500",cells:[{row:0,col:0,rowSpan:0,colSpan:2,content:"遥遥领先"},{row:0,col:1,rowSpan:0,colSpan:0,content:""},{row:0,col:2,rowSpan:0,colSpan:0,content:""},{row:1,col:0,rowSpan:0,colSpan:0,content:""},{row:1,col:1,rowSpan:0,colSpan:0,content:""},{row:1,col:2,rowSpan:0,colSpan:0,content:""}]});i.set("left",e.left-i.width/2),i.set("top",e.top-i.height/2),t.add(i)}getRandomShape(){const t=this.canvas.getCenter(),e=new fabric.Circle({name:"circle",left:t.left,top:t.top-80,radius:60,fill:"pink"}),i=new fabric.Rect({name:"rect",left:t.left,top:t.top,width:200,height:100,fill:"#fff"}),o=new fabric.IText("可编辑文本",{left:t.left,top:t.top+50,fill:"#000"}),n=new fabric.Textbox("hello world",{left:t.left,top:t.top,fill:"#000",width:200}),l=new fabric.Control({x:0,y:.5,mouseUpHandler:function(t,e){const i=getLocalPoint(e,e.originX,e.originY,x,y);if(e.originX===CENTER||e.originX===RIGHT&&i.x<0||e.originX===LEFT&&i.x>0){const{target:t}=e,o=t.strokeWidth/(t.strokeUniform?t.scaleX:1),n=isTransformCentered(e)?2:1,l=t.width,a=Math.ceil(Math.abs(i.x*n/t.scaleX)-o);return t.set("height",Math.max(a,0)),l!==t.width}return!1}});n.controls={...n.controls,mb:l};const a=[e,i,o,n];return Math.floor(Math.random()*a.length),n}elById(t){return document.getElementById(t)}}const editor=new LabelEditor("canvasBox");