const mm2px=t=>25*t;class LabelEditor{canvas;history=[];width=76;height=30;constructor(t){this.init(t)}init(t){const e=new fabric.Canvas(t,{stopContextMenu:!0,controlsAboveOverlay:!0,preserveObjectStacking:!0,altSelectionKey:"altKey",width:mm2px(this.width),height:mm2px(this.height),backgroundColor:"#fff"});this.canvas=e,window.innerWidth,window.innerHeight,this.initZoom(),this.initHistory(),this.initExport(),this.initEvents(),this.initComponents(),this.save()}initWorkshop({width:t,height:e}={width:800,height:800}){const i=this.canvas,n=document.querySelector("#workshop");i.setWidth(n.offsetWidth),i.setHeight(n.offsetHeight);const o=i.getCenter(),s=new fabric.Rect({fill:"blue",width:t,height:e,id:"workspace",left:o.left,top:o.top,originX:"center",originY:"center",selectable:!1,hasControls:!1});s.hoverCursor="default",i.add(s),s.clone((t=>{i.clipPath=t,i.requestRenderAll()}))}initEvents(){const t=document.getElementById("add"),e=document.getElementById("remove");t.addEventListener("click",(()=>{const t=this.getRandomShape(),e=this.canvas.getCenter();t.set("left",e.left-t.width/2),t.set("top",e.top-t.height/2),this.canvas.add(t),this.save()})),e.addEventListener("click",(()=>{const t=this.canvas.getActiveObjects();t.length>0&&(this.canvas.discardActiveObject(),t.forEach((t=>this.canvas.remove(t))),this.save())})),["centerH","centerV","center"].forEach((t=>{this.elById(t).addEventListener("click",(()=>{const e=this.canvas.getActiveObject();e&&e[t]()}))})),this.initPrint()}initHistory(){const t=this.canvas;t.on({"object:modified":this.save.bind(this)}),document.getElementById("undo").addEventListener("click",(()=>{const e=this.history;t.getActiveObjects().length>0&&t.discardActiveObject();const i=e[e.length-2];console.log("undo ",e,i),i&&(t.clear(),t.loadFromJSON(i,(()=>{t.renderAll(),e.pop(),console.log("undo after",e)})))}))}save(t){const e=this.canvas,i=this.history,n=e.toJSON(["id","selectable","hasControls","compType"]);i.push(n)}initExport(){const t=this.canvas;document.getElementById("export").addEventListener("click",(()=>{console.log(t.toJSON(["compType"]))}))}initZoom(){const t=this.canvas;t.on("mouse:wheel",(e=>{const i=e.e.deltaY;let n=t.getZoom();n*=.999**i,n>20&&(n=20),n<.01&&(n=.01);const o=t.getCenter();t.zoomToPoint({x:o.left,y:o.top},n),e.e.preventDefault(),e.e.stopPropagation()}))}initComponents(){const t=this.canvas,e=t.getCenter();fabric.Image.fromURL("qr_code.png",(i=>{i.scale(.2),i.set("left",e.left),i.set("top",e.top+140),i.set("originX","center"),i.set("originY","center"),i.set("compType","qrcode"),t.add(i),this.save()}));const i=new fabric.Circle({name:"circle",left:e.left,top:e.top-80,radius:60,fill:"pink",originX:"center",originY:"center"}),n=(new fabric.Rect({name:"rect",left:e.left,top:e.top,width:200,height:100,fill:"#fff",originX:"center",originY:"center"}),new fabric.Textbox("可编辑文本",{left:e.left,top:e.top+50,originX:"center",originY:"center",width:100,lockScalingX:!1,lockScalingY:!1})),o=new fabric.Textbox("hello world",{left:e.left,top:e.top,originX:"center",originY:"center",width:200,lockScalingX:!1,lockScalingY:!1});let s;t.add(o,n,i);const a=()=>{const t=n.__corner;t&&"mr"!==t&&"ml"!==t&&(s=n.height*n.scaleY),n.set({height:s||n.height,scaleY:1})};n.on("scaling",a),n.on("editing:entered",a),n.on("text:changed",a)}addTable(t=2,e=2){const i=this.canvas,n=40,o=[];for(let i=0;i<t+1;i++)o.push(new fabric.Line([90*i,0,90*i,e*n],{stroke:"#ccc",selectable:!1,strokeUniform:!0}));for(let i=0;i<e+1;i++)o.push(new fabric.Line([0,i*n,90*t,i*n],{stroke:"#ccc",selectable:!1,strokeUniform:!0}));for(let i=0;i<t;i++)for(let t=0;t<e;t++){const e=new fabric.Textbox(`${i}-${t}`,{fontSize:10,left:90*t+1,top:i*n+1,width:90,height:n,textAlign:"left",type:"cellText",stroke:"#fff",fontSize:20,lineHeight:n});o.push(e)}const s=i.getCenter(),a=new fabric.Group(o,{selectable:!0,backgroundColor:"green",subTargetCheck:!0,objectCaching:!1});a.on("mousedblclick",(t=>{const[e]=t.subTargets;e&&(i.setActiveObject(e),e.enterEditing(),a.addWithUpdate())})),a.on("mousedown",(t=>{console.log(t);const[e]=t.subTargets;e&&e.set("stroke","red")})),i.on("object:modified",(t=>{console.log("ddd",t)})),a.set("left",s.left-a.width/2),a.set("top",s.top-a.height/2),i.add(a)}initPrint(){document.getElementById("print").addEventListener("click",(async()=>{const t={pageWidth:this.width,pageHeight:this.height,paperRotate:"0"},e=this.canvas.toDataURL({format:"jpeg",quality:1,multiplier:1});let i=new Array(5).fill(e);const n={width:mm2px(this.width),height:mm2px(this.height)};console.time("压缩图片"),i=await this.processImagesInSW(i,n),console.timeEnd("压缩图片"),this.printImage(t,i)}))}async loadBlobBySrc(t){return await fetch(t).then((t=>t.blob()))}async processImagesInSW(t,e){const i=t.map((t=>this.loadBlobBySrc(t))),n=await Promise.all(i);return new Promise(((t,i)=>{let o=new Worker("process-image.js");o.onmessage=({data:e})=>{t(e),o.terminate()},o.postMessage({data:n,options:e})}))}async processImagesInCanvas(t,e){const i=t.map((async(t,i)=>this.scaleDownImage(t,{index:i,...e})));return await Promise.all(i)}getRandomShape(){const t=this.canvas.getCenter(),e=new fabric.Circle({name:"circle",left:t.left,top:t.top-80,radius:60,fill:"pink"}),i=new fabric.Rect({name:"rect",left:t.left,top:t.top,width:200,height:100,fill:"#fff"}),n=new fabric.IText("可编辑文本",{left:t.left,top:t.top+50,fill:"#000"}),o=new fabric.Textbox("hello world",{left:t.left,top:t.top,fill:"#000",width:200}),s=new fabric.Control({x:0,y:.5,mouseUpHandler:function(t,e){const i=getLocalPoint(e,e.originX,e.originY,x,y);if(e.originX===CENTER||e.originX===RIGHT&&i.x<0||e.originX===LEFT&&i.x>0){const{target:t}=e,n=t.strokeWidth/(t.strokeUniform?t.scaleX:1),o=isTransformCentered(e)?2:1,s=t.width,a=Math.ceil(Math.abs(i.x*o/t.scaleX)-n);return t.set("height",Math.max(a,0)),s!==t.width}return!1}});o.controls={...o.controls,mb:s};const a=[e,i,n,o];return Math.floor(Math.random()*a.length),o}elById(t){return document.getElementById(t)}getPaperSize(t){const{pageWidth:e,pageHeight:i,paperRotate:n}=t,o=`${e}mm`,s=`${i}mm`,a={0:[o,s],180:[o,s],90:[s,o],270:[s,o]},[c,r]=a[n]||[o,s];return{w:c,h:r}}async printImage(t,e){const{pageWidth:i,pageHeight:n,paperRotate:o}=t,{w:s,h:a}=this.getPaperSize({pageWidth:i,pageHeight:n,paperRotate:o});console.log(s,a);const c=window.getCLodop();if(c.PRINT_INIT(""),Array.isArray(e))return e.forEach((t=>this.createOnePage(t,s,a))),c.SET_PRINT_MODE("CUSTOM_TASK_NAME",Date.now()),c.PRINT()}createOnePage(t,e,i){t&&"data:,"!==t&&(LODOP.NewPageA(),LODOP.SET_PRINT_PAGESIZE(1,e,i,""),LODOP.ADD_PRINT_IMAGE(0,0,e,i,t),LODOP.SET_PRINT_STYLEA(0,"Stretch",1))}async scaleDownImage(t,e){const{width:i,height:n,index:o}=e,s=`scaleDownImage${o}`;console.time(s);const a=document.createElement("canvas");a.width=i,a.height=n;const c=a.getContext("2d");c.fillStyle="#fff",c.fillRect(0,0,i,n);const r=await this.loadImg(t);console.log("图片宽高：",r.width,r.height);const[l,h,d,g]=this.aspectFit(r.width,r.height,i,n);c.drawImage(r,l,h,d,g);const p=a.toDataURL("image/jpeg",1),f=await this.loadImg(p);return document.body.appendChild(f),console.timeEnd(s),p}aspectFit(t,e,i,n){const o=t/e,s=i/n;let[a,c,r,l]=[];return o>=s?(r=i,l=i/o):(l=n,r=n*o),a=(i-r)/2,c=(n-l)/2,[a,c,r,l]}async loadImg(t){return new Promise(((e,i)=>{const n=new Image;n.addEventListener("load",(()=>{e(n)})),n.addEventListener("error",(()=>{i(new Error("加载图片失败"))})),n.src=t}))}}const editor=new LabelEditor("canvasBox");